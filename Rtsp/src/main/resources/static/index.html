<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Testing HLS</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script lang="javascript">
        /* video Element */
        let video = null;

        /* 샘플 m3u8 url */
        let videoSrc = fetchUrl('http://localhost:5002/rtsp/windows').then(data => data.url);
        console.log('HLS Url = ', videoSrc);

        /* DOMContentLoaded 로드를 통해 video Element 담기*/
        window.addEventListener("DOMContentLoaded", () => {
            initVideo();
            initHls();
        })

        /* initVideo */
        const initVideo = () => {
            video = document.querySelector('#video')
        }

        /* HLS 초기화 */
        const initHls = () => {
            if (Hls.isSupported()) {
                hls = new Hls({
                    autoStartLoad: false,
                });
                hls.loadSource(videoSrc.url);
                hls.attachMedia(video);
                hls.startLoad();
            }
            /* ios/safari 같은 경우에 hls가 built-in 되어있다.*/
            else {
                video.src = videoSrc.url;
            }
        }

        /* Rest API에 요청 전송 */
        function fetchUrl(url, method = 'GET') {
            return window.fetch(url, { method })
                .then(response => {
                    // 응답 데이터를 JSON으로 파싱하여 반환
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // JSON 파싱
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    throw error; // 예외 다시 던지기
                });
        }
    </script>
</head>
<body>
<video id="video" controls playsinline autoplay></video>
</body>
</html>